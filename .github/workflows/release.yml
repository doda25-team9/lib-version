name: Release Stable Version

on:
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_PAT }}

      - uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Get release version
        id: version
        run: |
          CURRENT=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          if [[ "$CURRENT" != *"-SNAPSHOT" ]]; then
            echo "Error: Current version is not a SNAPSHOT"
            exit 1
          fi
          RELEASE=${CURRENT%-SNAPSHOT}
          echo "release=$RELEASE" >> $GITHUB_OUTPUT

      - name: Update to release version
        run: |
          mvn -B versions:set -DnewVersion=${{ steps.version.outputs.release }} -DgenerateBackupPoms=false
          mvn -B versions:commit
          echo "version=${{ steps.version.outputs.release }}" > src/main/resources/version.properties

      - name: Commit release version
        run: |
          git add pom.xml src/main/resources/version.properties
          git commit -m "chore: release version ${{ steps.version.outputs.release }}"

      - name: Create release tag
        run: git tag -a "v${{ steps.version.outputs.release }}" -m "Release version ${{ steps.version.outputs.release }}"

      - name: Build and deploy
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: mvn -B clean deploy -DskipTests

      - name: Bump to next development version
        run: |
          mvn -B build-helper:parse-version versions:set \
            -DnewVersion=\${parsedVersion.majorVersion}.\${parsedVersion.minorVersion}.\${parsedVersion.nextIncrementalVersion}-SNAPSHOT \
            -DgenerateBackupPoms=false
          mvn -B versions:commit
          SNAPSHOT=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "version=$SNAPSHOT" > src/main/resources/version.properties

      - name: Commit development version
        run: |
          git add pom.xml src/main/resources/version.properties
          git commit -m "chore: bump to next development version"

      - name: Push changes
        run: |
          git push origin main
          git push origin --tags

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "v${{ steps.version.outputs.release }}" \
            --title "Release v${{ steps.version.outputs.release }}" \
            --notes "Release version ${{ steps.version.outputs.release }}" \
            target/lib-version.jar